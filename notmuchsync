#!/usr/bin/env python
"""
    (c) 2010 Sebastian Spaeth Sebastian@SSpaeth.de
    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 2 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with this program.  If not, see <http://www.gnu.org/licenses/>.
"""
from notmuch.notmuch import Notmuch
import logging, sys

#---------------------------------------------------------------------------
# MAIN
#---------------------------------------------------------------------------
if __name__ == '__main__':
    #set up the logger
    logging.basicConfig(level=logging.INFO,
                        format="%(asctime)s - %(levelname)s - %(message)s",
                        datefmt="%Y%m%d %H:%M:%S")

    notmuch = Notmuch()

    # output help text by default
    if len(sys.argv) == 1:
        sys.argv.append('-h')

    UsageText = """notmuchsync  Copyright (C) 2010 Sebastian Spaeth
This program comes with ABSOLUTELY NO WARRANTY. It is released under the GNU GPL v2 (or later).

Usage:
-p --prune\tPrune deleted mails (use --dryrun for no real action)
-s --sync\tSync from notmuch tags to maildir flags.\n\t\tBy default it will only look for mails from the last 30 days.\n\t\tUse --all to look at earlier mails. (probably nonworking for huge maildirs as it reads all mails into RAM)
\t\tNote that if timestamps are more than 30 days in the future, we won\'t handle it.
-r --revsync\tSync tags from maildir to notmuch. See also -s.

Options:
-d\t\tReally verbose debug output.
-q\t\tLog only errors.
-n\t\tDo not call 'notmuch new' before and after operations
--dryrun\tDo not really modify notmuch db or mail files. Works with -p -r -s commands."""

    #TODO: proper options parsing/handling
    dryrun = '--dryrun' in sys.argv
    all_mails = '--all' in sys.argv
    notmuchnew = '-n' not in sys.argv
    if '-d' in sys.argv:
        logging.getLogger().setLevel(logging.DEBUG)
    elif '-q' in sys.argv:
        logging.getLogger().setLevel(logging.WARN)

    for arg in sys.argv[1:]:
        if arg in ['-h','--help']:
            print (UsageText)
        elif arg in ['-p','--prune']:
            #prune all mails with a "delete" tag
            if notmuchnew: notmuch.new()
            notmuch.prune(dryrun=dryrun)
            if notmuchnew: notmuch.new()
        elif arg in ['-r','--revsync']:
            #synchronize tags in maildir
            if notmuchnew: notmuch.new()
            notmuch.syncTags(frommaildir=True, dryrun=dryrun,
                             all_mails=all_mails)
        elif arg in ['-s','--sync']:
            #synchronize Unread tags in notmuch
            if notmuchnew: notmuch.new()
            notmuch.syncTags(frommaildir=False, dryrun=dryrun,
                             all_mails=all_mails)
            if notmuchnew: notmuch.new()
